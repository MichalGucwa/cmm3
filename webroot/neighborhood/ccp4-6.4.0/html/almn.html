<html>
<head><title>CCP4 Program Suite</title></head>
<body>

<!-- ::INDEX_INFO::ALMN::Supported::Molecular Replacement::calculates rotation function overlap values using FFT techniques::alternative to AMORE:::::: -->

<h1> ALMN (CCP4: Supported Program)</h1>
<h2> NAME</h2>
<p><b>almn </b>
- calculates rotation function overlap values using FFT techniques</p>

<h2> SYNOPSIS</h2>
<p><b>almn  hklin</b>
<i>foo_mol1[.mtz]</i>
<b>hklin2</b>
<i>foo_mol2[.mtz]</i>
<b>mapout</b>
<i>foo_almn[.map]</i><br />
 [<a href="#keywords">Keyworded input</a>]</p>

<h2><a name="description">DESCRIPTION</a></h2>

<p><b>almn</b>
is a fast rotation function which works in Eulerian
angles, an extension of the Crowther Rotation program by Eleanor
Dodson (York University). The program calculates
rotation function overlap values using FFT techniques (ref. R.A.Crowther
The Molecular Replacement Method ed. M. Rossmann). The original three
programs have been merged into the one here by Eleanor Dodson. She has also
extended the output to detail symmetry related Eulerian angles, spherical
polars and direction cosines for each peak in the output Eulerian angle
map.</p>
<p>The position of peaks is given for all symmetry related positions in
both Eulerian and polar angles.</p>
<p>The axis conventions have been generalised and it is possible
to deal with all space groups.</p>
<p>The correlation between self- and cross-rotation
functions can be analysed with the program
<a href="rfcorr.html">RFCORR</a>.</p>
<p>Options are provided in the program for various restart points.</p>

<ol>
<li><p>The results of the first stage of the calculation (ALMN) may also 
be saved for subsequent rotation function summations on different grids.
Beware however these spherical harmonics change for different
resolution and integration sphere cut off values.</p></li>

<li><p>The calculated rotation map is written to a standard CCP4 map
file, which can be used as input for the program
<a href="mapmask.html">MAPMASK</a>,
if a set of spacegroup symmetry operations can be derived, or can be
plotted with a standard package (<em>e.g.</em>, <a href="npo.html">npo</a>).
The program will reread this file to do a peak
search (see description of the keyword <a href="#find">FIND</a> for details of symmetry).</p></li>

<li><p>A list of peaks may be read in, and all symmetry related peaks 
generated (option PEAK).</p></li>
</ol>

<h2><a name="note_on_symmetry"></a>A NOTE ON SYMMETRY AND ASYMMETRIC UNITS</h2>

<p>If the spacegroups have more than one symmetry operation, additional 
rotation solutions are generated by their combination. The asymmetric 
units required are calculated in the program.</p>

<h2><a name="keywords"></a>KEYWORDED INPUT</h2>

<p>Only the first 4 letters of each keyword are necessary. All input is free
format. Many data cards are optional. The input to this program is intended
to be as similar as possible to that for the polar angle rotation
function program <b>POLARRFN</b>;
however there are a few differences, so beware.</p>
<p>The various data control lines are identified by keywords, those
available being:</p>
<blockquote>
<a href="#cross"><b>CROSS</b></a>,
<a href="#crystal"><b>CRYSTAL</b></a> (compulsory),
<a href="#end"><b>END</b></a>,
<a href="#find"><b>FIND</b></a>,
<a href="#labin"><b>LABIN</b></a>,
<a href="#limits"><b>LIMITS</b></a>,
<a href="#lsphere"><b>LSPHERE</b></a>,
<a href="#map"><b>MAP</b></a>,
<a href="#maxref"><b>MAXREF</b></a>,
<a href="#noprint"><b>NOPRINT</b></a>,
<a href="#peak"><b>PEAK</b></a>,
<a href="#print"><b>PRINT</b></a>,
<a href="#read"><b>READ</b></a>,
<a href="#resolution"><b>RESOLUTION</b></a>,
<a href="#rotsym"><b>ROTS</b></a>,
<a href="#save"><b>SAVE</b></a>,
<a href="#self"><b>SELF</b></a>,
<a href="#sum"><b>SUM</b></a>,
<a href="#title"><b>TITLE</b></a>,
<a href="#xmlo"><b>XMLOUTPUT</b></a>
</blockquote>

<h3><a name="title">TITLE</a> title</h3>
<p>The rest of the line is taken as a title.</p>

<h3><a name="self"></a>SELF sphmin sphmax</h3>
<p>Set flag for self rotation (c.f. keyword <a href="#cross">CROSS</a>), and set radii for integration
(in either order).</p>
<dl>
<dt>SPHMAX</dt>
<dd>outer radius of the cutoff sphere in Patterson function space
(Angstrom).</dd>
<dt>SPHMIN</dt>
<dd>inner radius of the cutoff sphere in Patterson function space
(Angstrom) Sphmin should be more than 0.9*RESMAX.</dd>
</dl>

<h3><a name="cross"></a>CROSS sphmin sphmax</h3>
<p>Set flag for cross rotation (c.f. keyword <a href="#self">SELF</a>), and set radii for integration
as for SELF</p>

<h3><a name="lsphere">LSPHERE</a> no</h3>
<p>If the sphere radius is so large that the sphere volume is greater than 50% of the
asymmetric unit volume, and the logical flag LSPHERE is not set, then the 
radius is automatically reset to give sphere volume = 50% of asymmetric unit volume.</p>

<h3><a name="resolution">RESOLUTION</a> resmin  resmax</h3>
<p>Read resolution limits in Angstroms, in either order. If only one is
given, it is treated 
as the high resolution limit. Note that because of the limit of 60 Bessel
functions in this version, the integration radius SPHMAX cannot be greater
than 12*RESMAX: if it is, the program resets RESMAX to SPHMAX/12.0.</p>
<p>The program chooses whether to use the 30 or 60 Bessel function tables
as appropriate: 30 if SPHMAX/RESMAX &lt; 5.83, and 60 otherwise.</p>

<h3> <a name="crystal"></a>CRYSTAL </h3>
<p>Followed by subsidiary keywords and numbers.</p>
<p>This card is COMPULSORY for each hklin set (one for self-rotation,
two for cross-rotation). The first keyword FILE indicates whether
this CRYSTAL card refers to crystal 1 or to crystal 2.</p>
<dl>
<dt>subsidiary keyword FILE</dt>
<dd>followed by crystal number 1 or 2 (default 1). The syntax is any one
of `FILE 1' or `FILE 2'.</dd>
<dt>subsidiary keyword ORTH</dt>
<dd>followed by orthogonalisation code NCODE for this crystal.
<pre>
 = 1 orthogonal x y z along a,c*xa,c* (Brookhaven, default)
 = 2 b,a*xb,a*
 = 3 c,b*xc,b*
 = 4 a+b,c*x(a+b),c*
 = 5 a*,cxa*,c   (Rollett)
</pre></dd>
<dt>subsidiary keyword BFAC</dt>
<dd>followed by temperature factor B (default = 0). This can be used to
sharpen the input F by exp**-[BFAC*sin**2(theta)/lambda**2]
before squaring, <em>i.e.</em> a negative BFAC will sharpen the data.</dd>
<dt>subsidiary keyword FLIMITS</dt>
<dd>followed by minimum F (default = 0) and
maximum F (default = 1000000000) in either order. The test is done
after application of the temperature factor, but before squaring to
intensities. This is used to restrict the number of reflections used
in the calculation to less than 10000. The program dimensions can be
increased but there is little point in including weak data.</dd>
<dt>subsidiary keyword SCALE</dt>
<dd>followed by scalfactor to divide Fsquared.
Sometimes needed to reduce overflows.</dd>
<dt>subsidiary keyword CELL</dt>
<dd>followed by a b c 
(alpha beta  gamma - default = 90.0)
Rarely needed - just for peak analysis.</dd>
<dt>subsidiary keyword SYMMETRY</dt>
<dd>followed by space group number or name.
The crystal symmetry will be read from a symmetry library (logical
name SYMOP). The spacegroup name is <em>e.g.</em> P212121.</dd>
</dl>

<h3><a name="labin">LABIN</a></h3>
<p>Followed by subkeyword FILE followed by file number and then
followed by MTZ file assignments for F and optionally for SIGF,
<em>e.g.</em> LABIN FILE 1 F=FO</p>

<h3><a name="limits"></a>LIMITS btmin btmax bstep</h3>
<p>Read limits and step on beta in degrees</p>

<h3><a name="print"></a>PRINT lprint</h3>
<p>Reset print threshold LPRINT (default = 1). The rotation function is
scaled to a maximum on the first section of 50.</p>

<h3><a name="noprint"></a>NOPRINT</h3>
<p>Switch off printing of map</p>

<h3><a name="map"></a>MAP</h3>
<p>Write rotation function to a map file: this is the default unless
only the PEAK option is used. This may be read back later
for plotting, peak searching, etc using the READ option.</p>

<h3><a name="maxref"></a>MAXREF</h3>
<p>Limit the number of reflections used to MAXREF - default 10000.</p>

<h3><a name="find"></a>FIND peak maxpek [RMS] [OUTPUT filename]</h3>
<p>Read peak threshold and maximum number of peaks.
MAXPEK is the maximum number of peaks to find (default = 20).
Up to MAXPEK peaks above PEAK will be found, and all symmetry
related peaks generated.</p>
<p>If the keyword RMS is present, then the peak threshold is
PEAK * RMS density, otherwise PEAK is the absolute threshold in the
scaled map.</p>
<p>If the keyword OUTPUT is present, the unique peaks will be
output to a file whose name may also be given (default filename
or logical name PEAKS). The keyword RMS must precede OUTPUT if
both are present.</p>
<p>Note that the program finds rho(max) in a 3x3x3 box. It attempts
to interpolate the peak positions, but may not do very well
at this near beta = 0 or 180 where the peaks are very elongated.
It DOES NOT deal with map edges properly - if you want to do this
you will need to run the program
<b>EXTEND</b>
with the proper
rotational Eulerian angle symmetry. This can be deduced from the
symmetry equivalents generated for a Alpha Beta Gamma set in a
general position.  The map is written with a cell with
dimensions 360 360 360 90 90 90, and a grid in steps of 5
degrees or 2.5 degrees. A symmetry operation (120 + alpha, 180 -
beta, -gamma) would be generated by an entry 1/3+x,1/2-y,-z in a
fake spacegroup.</p>

<h3><a name="save"></a>SAVE</h3>
<p>Save ALMN coefficients files (<em>i.e.</em>, open them `NEW' not `SCRATCH') for
future use with the SUM option (q.v.). Not useful.</p>

<h3><a name="sum"></a>SUM</h3>
<p>Read ALMN coefficients from files generated in a previous run of the
program (saved with the SAVE command). Not useful.</p>
<p>It is possible to start again after the first stage of rotation has been 
done. The ALMN coefficients for each crystal are written to files with 
the default names COEFFS1 and COEFFS2. These files can be used to save
time on a later run of the program.</p>

<h3><a name="rotsym"></a>ROTSYM irsygp</h3>
<p>If you know the rotation symmetry, you can make an entry into
the SYMOP file with `spacegroup number' IRSYGP, then it will
be written to the output map. This can be helpful for some fancy
plots, but is not normally useful.</p>

<h3><a name="read"></a>READ  [btmin] [btmax]</h3>
<p>Instead of calculating the rotation function, read a previously
calculated map, written out using the MAP command. This allows you
to FIND peaks at a lower or higher level, and generate symmetry
equivalents, or to PRINT it to the lineprinter. To generate symmetry 
the program requires cards SELF or CROSS, and SYMMETRY (<em>i.e.</em> the
number of symmetry operators must be defined).</p>
<p>If parameters and BTMAX are present, only sections between
these values of Beta are read. Otherwise the whole map is read.</p>

<h3><a name="peak"></a>PEAK</h3>
<p>Read a list of peak positions (alpha beta gamma in degrees) from
subsequent lines,<br /><a name="end"></a>terminated by a blank line, `END' or end of file.
The program will not calculate a rotation function, but will generate
all symmetry related peaks from the peaks given, and print out the
corresponding matrices. This option requires cards SELF or CROSS,
CELL, and SYMMETRY (<em>i.e.</em> the number of crystals, their
symmetry and orthogonalisation codes must be defined).</p>

<h3><a name="xmlo"></a>XMLOUTPUT</h3>

<p>This keyword is of little use for the 'user'. When specified almn will 
output a small XML file of the reindex operator. The name and location 
of the XML file can be 
specified on the command line with XMLFILE, otherwise the file will be called 
ALMN.xml.</p>

<p>Example of output file<br>
<pre>&lt;?xml version="1.0"?&gt;
 &lt;almn_run&gt;
  &lt;ALMN
    ccp4_version="4.1" 
    date=" 1/24/02" 
   /&gt;
  &lt;reindex_operator
    required="yes" 
    operator="-h,-k,l"
   /&gt;
 &lt;/almn_run&gt;
</pre>
<p>
<h2><a name="file"></a>INPUT AND OUTPUT FILES</h2>
<dl>
<dt>HKLIN</dt>
<dd>input amplitudes for crystal 1</dd>
<dt>HKLIN2</dt>
<dd>input amplitudes for crystal 2</dd>
<dt>MAPIN</dt>
<dd>input map for READ option</dd>
<dt>MAPOUT</dt>
<dd>output map for MAP option</dd>
<dt>SYMOP</dt>
<dd>symmetry library</dd>
<dt>COEFFS1</dt>
<dd>ALMN coefficients for crystal 1</dd>
<dt>COEFFS2</dt>
<dd>ALMN coefficients for crystal 2</dd>
</dl>
<p>By default COEFFS1 and COEFFS2 are created as scratch files.</p>

<h2><a name="notes"></a>NOTES</h2>
<ol>
<li>If intensities are to be included to a Fourier cut-off of RESMAX A,
for a cut-off sphere of radius a A in the Patterson density, the
maximum value of L (Bessel coefficient) that should be included is
approximately
<br />
Lmax = 2 pi a / RESMAX
<br />
The program allows Bessel functions up to
order 60, hence the following restrictions on values of RESMAX and a:
<pre>
 
 RESMAX           a
 ------           -
 6  A          72 A
 8  A          96 A
 10 A         120 A
 
</pre>
</li>
<li>If there are two crystals, it is the crystal represented by the second
data stream which is rotated, while the crystal represented by the
first data stream is held fixed. The output of final angles are
therefore those required to rotate the second crystal to the orientation of
the first. In particular the alpha, beta, gamma are the Eulerian
angles for rotating axes as defined by Tony Crowther. They convert the
density of crystal 2 to that of crystal 1 by rotating crystal 2 first
through gamma about Zo, then through beta about Yo, then through alpha
about Zo relative to the fixed axes. Positive rotation clockwise is
when looking along the axis from the origin. The rotations are carried
out in the ORTHOGONAL frame, which is related to the crystallographic
frame according to the setting of the ORTH flag. Beware of the
permutations introduced by ORTH .ne. 1.</li>
</ol>

<h2><a name="printer_output"></a>PRINTER OUTPUT</h2>
<p>The line printer output contains details of the input parameters, the
orientation matrices for hkl and xyz for each crystal, summaries of
the reflection data and finally values of the rotation function
maxima and the
associated angles including symmetry related sets.  A map will also be
printed if this was requested.</p>

<p>The program also automatically performs extra analysis to see whether
the indexing is consistent between HKLIN and HKLIN2, and if reindexing is
required then it will suggest which reindexing operation should be used on
HKLIN2 to give consistent indexing. The <a href="reindex.html">REINDEX</a>
program can be used to perform the actual reindexing.</p>

<h2><a name="errors"></a>ERROR MESSAGES</h2>
<p>The program calculates the array sizes required for a given problem,
lists these, and will stop if the values exceed those set in the program.
There is also a limit of 10000 reflections for any given reflection data set:
the program will try to reset the minimum intensity to get an acceptable 
number.</p>

<h2><a name="references"></a>REFERENCES</h2>
<ol>
<!-- KEEP startreferencelist -->
<li> R.A.Crowther, The Fast Rotation Function in <i>The Molecular Replacement
Method</i> ed. M.G. Rossman, <i>Int. Sci. Rev. Ser.</i>, no. 13, pp. 173-178 (1972).</li>
<li>E.J.Dodson, in <i>Molecular Replacement</i>, Proceedings of the Daresbury 
Study Weekend, (1985) DL/SCI/R23</li>
<!-- KEEP endreferencelist -->
</ol>

<h2>AUTHORS</h2>
<p>Originator:    Tony Crowther/Eleanor Dodson
<br />
Contact:       Daresbury Laboratory/York University</p>

<h2><a name="program_structure"></a>PROGRAM STRUCTURE</h2>
<p>The main program carries out the following functions:
<ol>
<li>Initialisations</li>
<li>Input of control data</li>
<li>Checks limits determined by array sizes</li>
<li>Calculates and sets up a table of spherical Bessel function coefficients</li>
<li>Input of one (or two reflection files) including summation loop to calculate ALMN and BLMN</li>
<li>Fast rotation function summation (subroutine FRFS)</li>
<li>Checks consistency of indexing between input files</li>
</ol>

<h2>SEE ALSO</h2>
<p> <a href=mapmask.html>MAPMASK</a>,
 <a href=npo.html>npo</a>,
 <a href=polarrfn.html>polarrfn</a>,
 <a href=rfcorr.html>rfcorr</a>,
 <a href=reindex.html>reindex</a>.</p>

<h2><a name="examples">EXAMPLES</a></h2>
<p>The following are examples of control data.</p>

<h3>A complete self rotation calculation</h3>
<pre>
#
# PPb R-state self-rotation function
#
almn  hklin ppbt_calc mapout almnself &lt;&lt; eof
TITLE PPb R-state Fcalc self-rotn fn, res 15-6, radius 0 30
SELF 3 30  
RESOLUTION  15 6
CRYSTAL  FILE 1 ORTHOG 3 BFAC -20
LABIN FILE 1 F=FC 
LIMITS 0 90 5
PRINT
FIND  2 30 RMS OUTPUT self_peaks
END
eof
#
#  Now read back map to search at different limits
# 
almn  hklin ppbt_calc mapout almnself &lt;&lt; eof
TITLE PPb R-state Fcalc self-rot fn, res 15-6, radius 0 30
SELF 3 30  
RESOLUTION  15 6
CRYSTAL  FILE 1 ORTH 3 BFAC -20
LABIN FILE  1 F=FC 
LIMITS 0 90 5
NOPRINT
READ
FIND  30 30 OUTPUT self_peaks
END
eof
</pre>

<h3>A complete cross rotation calculation</h3>
<pre>

#
almn hklin ovalnat   hklin2 alpha1t  map cross1 &lt;&lt; eof
TITLE Cross rotation function ovalbumin to tetragonal alpha1-PI
CROSS 5 30
RESOLUTION 10 6
CRYSTAL FILE 1 ORTHOG 1  BFAC 0
LABIN FILE 1 F=FOVALNAT  
CRYSTAL FILE 2 ORTHOG 1  BFAC 0
LABIN FILE 2  F=FCALPHA1T 
LIMITS  0 180 5
MAP
PRINT
FIND  2 20  RMS
END
eof
#
#
npo mapin cross1 plot cross &lt;&lt; eof
TITLE  Ovalbulmin cross rotation
MAP
CONTRS   60 TO 200 BY 20
SECTNS 0 36
SIZE   160
PLOT
eof
#

#
# PPb R-state cross-rotation function
#
#
almn  hklin ppb/p21all1   hklin2 ppbt_calc mapout almncross &lt;&lt; eof
TITLE PPb R-state cross-rot fn, Fobs, res 8-4, radius 0 20
CROSS  3 20
RESOLUTION  8 4
CRYSTAL  FILE 1 ORTHOG 3 BFAC -20 FLIMITS 100 999999 SYMMETRY 4
LABIN FILE 1 F=F 
CRYSTAL  FILE 2 ORTHOG 1 BFAC -20 FLIMITS 100 999999 SYMMETRY 1
LABIN FILE  1 F=FC 
LIMITS 0 90 5
FIND   3 20 RMS
END
eof
#
#
# Plot cross rotation function from ALMN
#
npo mapin almncross plot cross &lt;&lt; eof
TITLE PPb R-state cross-rot fn, Fobs, res 8-3, radius 0 20
CELL 100 100 100 90 90 90
MAP  SCALE 1.4
CONTRS  50 TO 200 BY 20
SECTNS  0 19
PLOT
eof
#
</pre>

</body></html>
