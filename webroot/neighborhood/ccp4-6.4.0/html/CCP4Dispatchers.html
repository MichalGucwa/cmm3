<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.8.1: http://docutils.sourceforge.net/" />
<title>Python Dispatchers for CCP4</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 6253 2010-03-02 00:24:53Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: left }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
<style type="text/css">

/*
:Author: David Waterman
:Contact: david dot waterman at stfc dot ac dot uk
:Copyright: This stylesheet has been placed in the public domain.

Stylesheet for use with Docutils to match CCP4 documentation format
*/

@import url(html4css1.css);

/* Remove centered alignment for title */

h1.title {
  text-align: left }

h2.subtitle {
  text-align: left }


</style>
</head>
<body>
<div class="document">


<div class="section" id="python-dispatchers-for-ccp4">
<h1>Python Dispatchers for CCP4</h1>
<!-- David Waterman 2013-05-02
This document is reStructuredText. -->
<div class="section" id="introduction">
<h2>Introduction</h2>
<p>CCP4Dispatchers is a project currently under development to provide
automatically generated Python dispatchers to wrap the executables distributed
with the CCP4 Suite.</p>
<p>The motivation for providing this is to encapsulate the set up of CCP4 environment
variables so that CCP4 programs can be run from Python scripts without worrying
about whether Python was started from a correct CCP4 environment. This
sidesteps the requirement to source one of the shell environment set up files (such as
ccp4.setup-sh or ccp4.setup-csh) on Linux and Mac systems, and for centrally set
environment variables on Windows. Instead, the correct environment is set by the dispatcher
just prior to program execution. In this way the environment is encapsulated,
avoiding problems caused by clashes of incompatible environment definitions
with non-CCP4 software. The provision of a standard package of Python
wrappers may be of benefit to the many authors who have previously written their
own dispatchers to wrap CCP4 programs. CCP4Dispatchers provide a guarantee of
portability, and use of the dispatchers works in the same way on all systems with
a compatible Python interpreter.</p>
<p>A generated dispatcher can be used from the command line as a drop-in
replacement for the executable it wraps, with no change to syntax.
Alternatively, the package CCP4Dispatchers can be imported within Python and
used to run CCP4 software as subprocesses. This provides a simple mechanism for
Python scripting of tasks using CCP4 programs.</p>
</div>
<div class="section" id="dispatcher-generation">
<h2>Dispatcher generation</h2>
<p>For binary distributions of the Suite, the CCP4Dispatchers package will have
been generated automatically as part of the installation. When the Suite has been
compiled from source, or when alternative environment definitions are required,
it will be necessary to use the straightforward procedure explained below to
generate the package.</p>
<p>Generating dispatchers is a two step process. First, an environment definition
file must be created, which contains the variable names and their values
defined, with one line per definition in one of the following formats:</p>
<pre class="literal-block">
VARIABLE=VALUE
export VARIABLE=VALUE
setenv VARIABLE VALUE
</pre>
<p>The reason for choosing these formats is that the environment definition file can
then double up as a script that may be sourced on systems with an
appropriate shell to obtain the same environment set by the dispatchers. Any
lines that do not adhere to this format are ignored. Shell-like substitutions are
allowed if they refer to lines previously defined. So a line like <tt class="docutils literal"><span class="pre">CBIN=$CCP4/bin</span></tt> will be
correctly interpreted as long as the value for <tt class="docutils literal">CCP4</tt> has already been set.</p>
<!-- The example file 'ccp4-env_win.txt' is provided as a template that may be
edited to obtain the correct environment definition file for a Windows
installation of the Suite. -->
<p>To make the process of determining the correct environment definition as easy as
possible, the Python program envExtractor.py may be used. This program writes out
a definition file based on the result of sourcing an existing 'ccp4.setup' script
in a sanitised environment. Therefore, a suitably edited version of the template
file 'ccp4.setup-sh' or 'ccp4.setup-csh' may be passed to envExtractor.py, which
will write out an environment definition, called for example
'ccp4-env.sh'.</p>
<p>The environment definition file created in the previous step may be passed to
dispatcherGenerator.py, along with the path to the directory containing CCP4
executables, to generate the CCP4Dispatchers package. By default, that package
will be created under the current directory. In order to follow the current
behaviour of the binary installer, the package should be generated under
$CCP4/share/python/. In addition, symbolic links (or .bat
files on Windows) pointing to the dispatchers will be written. These have the
same names as the programs wrapped by the dispatchers. This allows use of the
dispatchers to be
transparent; by adding the location of the links to PATH the dispatchers can
then be used from the command line exactly as if the programs were being used
directly.</p>
<p>Further usage instructions for envExtractor.py and dispatcherGenerator.py are printed
when they are run at the command line, without arguments. These
instructions show, for example, how to write the CCP4Dispatchers package elsewhere
than the current working directory, or to separate the directory of Python
modules from the symbolic links (or .bat files).</p>
</div>
<div class="section" id="using-ccp4dispatchers-within-python">
<h2>Using CCP4Dispatchers within Python</h2>
<p>The CCP4Dispatcher directory created by dispatcherGenerator.py is a Python
package, and the individual modules that set up Dispatcher classes for each
wrapped program may be not only run from the command line, but also imported
and used from an existing Python process. For this to work, the CCP4Dispatcher
directory must be on the Python search path. A typical way to achieve that is
to add its parent directory to the PYTHONPATH environment variable.</p>
<p>The CCP4Dispatcher package is designed to be flexible and may be used in
different ways to address different use cases. The best way to demonstrate
its functionality is to present the same CCP4 job (here the equivalent of
'refmac5-simple.exam') but run through the dispatchers in different
ways that meet requirements of some of those use cases.</p>
<div class="section" id="use-case-1-simply-start-a-job-and-wait-for-the-results">
<h3>Use case 1: Simply start a job and wait for the results</h3>
<p>The easiest way to run a CCP4 job inside Python, using CCP4Dispatchers, is
demonstrated by the following script:</p>
<pre class="literal-block">
from string import Template
import os
from CCP4Dispatchers import dispatcher_builder

cmd = Template(&quot;HKLIN $CEXAM/rnase/rnase18.mtz &quot; + \
               &quot;HKLOUT $CCP4_SCR/rnase_simple_out.mtz &quot; + \
               &quot;XYZIN $CEXAM/rnase/rnase.pdb &quot; + \
               &quot;XYZOUT $CCP4_SCR/rnase_simple_out.pdb&quot;)
cmd = cmd.substitute(os.environ)
keywords = &quot;&quot;&quot;LABIN FP=FNAT SIGFP=SIGFNAT FREE=FreeR_flag
NCYC 10
END
&quot;&quot;&quot;

d = dispatcher_builder(&quot;refmac5&quot;, cmd, keywords)
d.call()
</pre>
<p>Here, rather than directly import the refmac5 Dispatcher class, then
instantiate it with a separate statement, we import the
<tt class="docutils literal">dispatcher_builder</tt> factory function from the package and use that.
This has the advantage of brevity if many different Dispatchers are to be
used in a script, as only one <tt class="docutils literal">import</tt> line is needed. Additionally,
the desired Dispatcher is requested by a string matching the original
program name (with '.exe' removed from the name of Windows binaries) rather
than its Python module name. This aids the automatic import of valid
dispatcher modules, as their file names will differ from the original
program name in those cases that the original name does not comply with
Python's module naming conventions (such as names containing a '.').</p>
<p>The first time a name is imported from the CCP4Dispatchers package, the CCP4
environment is set automatically. This is what allows us to use the
convenient <tt class="docutils literal">Template</tt> strings of Python &gt; 2.4 in the above script to fill in the
values for the CCP4 environment variables CEXAM and CCP4_SCR in <tt class="docutils literal">cmd</tt>
from <tt class="docutils literal">os.environ</tt>. It does not imply that Python has to be started from a sourced CCP4
environment! For scripts that manipulate the environment in some way,
a method can be called to re-set the CCP4 environment at any
time that a Dispatcher is in scope. For example, in the above script
it could be called by <tt class="docutils literal">d.set_env()</tt>.</p>
<p>Using <tt class="docutils literal">dispatcher_builder</tt> allowed us to set the command line
string and program keywords as arguments to that function. If a
Dispatcher was constructed directly, these start as <tt class="docutils literal">None</tt>, and if command
line arguments or keywords are required for the job, they must be set
separately by methods of the Dispatcher, <tt class="docutils literal">set_cmd_args(value)</tt> and
<tt class="docutils literal">set_keywords(value)</tt>. In each case, <tt class="docutils literal">value</tt> must be either a string
or a list of strings.</p>
<p>The <tt class="docutils literal">call()</tt> method handles dispatch to the refmac5 binary, passing the command
line arguments and keywords, and returns the exit code once the process
completes. As a side-effect, the attributes <tt class="docutils literal">stdout_data</tt> and <tt class="docutils literal">stderr_data</tt> of <tt class="docutils literal">d</tt>
are set, containing the STDOUT and STDERR output from the process respectively.</p>
</div>
<div class="section" id="use-case-2-an-interactive-pipeline">
<h3>Use case 2: An interactive pipeline</h3>
<p>In some cases it is necessary to have more control over the running
sub-process. For those instances there is a different interface provided by
<tt class="docutils literal">call(wait=False)</tt>. This version of the script does not block on the <tt class="docutils literal">call</tt> statement,
but returns control immediately to the user script, which would allow
instantiation of further Dispatchers for parallel job execution:</p>
<pre class="literal-block">
from string import Template
import os
from CCP4Dispatchers import dispatcher_builder

cmd = Template(&quot;HKLIN $CEXAM/rnase/rnase18.mtz &quot; + \
               &quot;HKLOUT $CCP4_SCR/rnase_simple_out.mtz &quot; + \
               &quot;XYZIN $CEXAM/rnase/rnase.pdb &quot; + \
               &quot;XYZOUT $CCP4_SCR/rnase_simple_out.pdb&quot;)
cmd = cmd.substitute(os.environ)
keywords = &quot;&quot;&quot;LABIN FP=FNAT SIGFP=SIGFNAT FREE=FreeR_flag
NCYC 10
END
&quot;&quot;&quot;

d = dispatcher_builder(&quot;refmac5&quot;, cmd, keywords)
d.call(wait=False)

while d.isRunning:
    stdout_line, stderr_line = d.monitor()

    # Do something with stdout_line. If the job is going badly, can
    # call d.abort()
    if stdout_line: print stdout_line.rstrip()
</pre>
<p>This level of control does not come for free. Each Dispatcher caches data output to
STDOUT and STDERR in internal buffers. To access that data the user code must
monitor the Dispatcher in order to take data one line at a time from these
buffers. The
Dispatcher provides a method, <tt class="docutils literal">monitor()</tt>, to do this, which returns a tuple
containing a single line of
output from both STDOUT and STDERR of the process (or None is none is
available). As a side-effect <tt class="docutils literal">monitor</tt> also fills <tt class="docutils literal">d.stdout_data</tt> and <tt class="docutils literal">d.stderr_data</tt>
so that all of the lines can inspected after the program completes.</p>
<p>With this scheme it is incumbent upon the client code to call <tt class="docutils literal">monitor()</tt> enough
times that all of the output of the program is read. One way to ensure this happens is
to repeatedly call <tt class="docutils literal">monitor()</tt> while the attribute <tt class="docutils literal">d.isRunning</tt> is <tt class="docutils literal">True</tt>. This is
safe because this attribute is set to <tt class="docutils literal">False</tt> by <tt class="docutils literal">monitor()</tt> only when the subprocess
has completed execution <em>and</em> there are no more lines of output left to
read from either STDOUT or STDERR.</p>
<p>As this approach allows live progress monitoring of a running program, an
additional method, <tt class="docutils literal">abort()</tt>, is provided to cleanly stop a job if there is no
reason to let it run to completion.</p>
</div>
<div class="section" id="use-case-3-fire-and-forget">
<h3>Use case 3: &quot;Fire-and-forget&quot;</h3>
<p>For some applications it is useful to be able to start jobs without
blocking on the <tt class="docutils literal">call</tt>, but the requirement for a monitoring loop to
fill the <tt class="docutils literal">stdout_data</tt> and <tt class="docutils literal">stderr_data</tt> attributes is a needless
inconvenience because the user script does not need to interact
further with the job. In such cases it is possible to direct STDOUT and
STDERR to files, using the Dispatchers only to start the jobs. The
following script demonstrates how:</p>
<pre class="literal-block">
from string import Template
import os
from CCP4Dispatchers import dispatcher_builder

cmd = Template(&quot;HKLIN $CEXAM/rnase/rnase18.mtz &quot; + \
               &quot;HKLOUT $CCP4_SCR/rnase_simple_out.mtz &quot; + \
               &quot;XYZIN $CEXAM/rnase/rnase.pdb &quot; + \
               &quot;XYZOUT $CCP4_SCR/rnase_simple_out.pdb&quot;)
cmd = cmd.substitute(os.environ)

keywords = &quot;&quot;&quot;LABIN FP=FNAT SIGFP=SIGFNAT FREE=FreeR_flag
NCYC 10
END
&quot;&quot;&quot;

f1 = open(&quot;job.log&quot;,&quot;w&quot;)
f2 = open(&quot;job.err&quot;,&quot;w&quot;)

d = dispatcher_builder(&quot;refmac5&quot;, cmd, keywords, capture_streams=False, stdout=f1, stderr=f2)
d.call(wait=False)

f1.close()
f2.close()
</pre>
<p>The key point here is to request <tt class="docutils literal">capture_streams=False</tt> during the
instantiation of the Dispatcher. In that case the STDOUT and STDERR streams
are not redirected to the object. Instead, they may be redirected to another
location, given by the file objects passed as <tt class="docutils literal">stdout</tt> and <tt class="docutils literal">stderr</tt>.
As the above script does not wait for the job to finish it exits
quickly, leaving refmac5 writing to the files 'job.log' and 'job.err'.</p>
<p>It is not currently possible to use the <tt class="docutils literal">abort</tt> method for a Dispatcher
that was instantiated with <tt class="docutils literal">capture_streams=False</tt>. In principle, any
script that might need to abort a job it started should be keeping track
of that job using the monitoring loop mechanism described previously.</p>
</div>
<div class="section" id="fine-control-of-subprocesses">
<h3>Fine control of subprocesses</h3>
<p>The Dispatcher object exposes the most useful information about the
call, including <tt class="docutils literal">call_val</tt> and <tt class="docutils literal">call_err</tt> attributes that provide
the exit code from a completed job or the exception from a failed call.
However, it is also possible to interact directly with the
<tt class="docutils literal">subprocess.Popen</tt> object in case other information or methods are
required. The <tt class="docutils literal">subprocess.Popen</tt> object that the Dispatcher
<tt class="docutils literal">call</tt> method creates is assigned to the attribute <tt class="docutils literal">process</tt>.</p>
</div>
</div>
<div class="section" id="notes">
<h2>Notes</h2>
<p>Some further examples of using the dispatchers to run demonstration jobs are
provided in the 'example_scripts' subdirectory. See the project homepage at
<a class="reference external" href="https://fg.oisin.rc-harwell.ac.uk/projects/ccp4dispatchers/">https://fg.oisin.rc-harwell.ac.uk/projects/ccp4dispatchers/</a>.</p>
</div>
<div class="section" id="author">
<h2>Author</h2>
<p>David Waterman</p>
</div>
</div>
</div>
</body>
</html>
